<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.53">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Sharon Howard">
<meta name="dcterms.date" content="2025-05-30">
<meta name="description" content="How to get lists of query terms and counts of things in the OBO API">

<title>API terms and statistics – OldBaileyOnline ~ Data</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<link href="../site_libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">
<script src="../site_libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<script src="../site_libs/jsoneditor-0.18.7/jsoneditor.min.js"></script>
<script src="../site_libs/jsonedit-binding-4.0.0/jsonedit.js"></script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">OldBaileyOnline ~ Data</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/sharonhoward/obo"> <i class="bi bi-github" role="img" aria-label="Github">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#discovery" id="toc-discovery" class="nav-link" data-scroll-target="#discovery">Discovery</a></li>
  <li><a href="#digging-deeper" id="toc-digging-deeper" class="nav-link" data-scroll-target="#digging-deeper">Digging deeper</a>
  <ul class="collapse">
  <li><a href="#what-to-count-by" id="toc-what-to-count-by" class="nav-link" data-scroll-target="#what-to-count-by">what to count by?</a></li>
  <li><a href="#query-strings" id="toc-query-strings" class="nav-link" data-scroll-target="#query-strings">query strings</a></li>
  <li><a href="#a-crosstabs-example" id="toc-a-crosstabs-example" class="nav-link" data-scroll-target="#a-crosstabs-example">a crosstabs example</a></li>
  </ul></li>
  <li><a href="#scaling-up" id="toc-scaling-up" class="nav-link" data-scroll-target="#scaling-up">Scaling up</a>
  <ul class="collapse">
  <li><a href="#download-multiple-csvs" id="toc-download-multiple-csvs" class="nav-link" data-scroll-target="#download-multiple-csvs">download multiple CSVs</a></li>
  <li><a href="#all-the-combinations-for-crosstabs" id="toc-all-the-combinations-for-crosstabs" class="nav-link" data-scroll-target="#all-the-combinations-for-crosstabs">all the combinations for crosstabs</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">API terms and statistics</h1>
</div>

<div>
  <div class="description">
    How to get lists of query terms and counts of things in the OBO API
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Sharon Howard </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">30 May 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>There were a couple of convenient features in the old OBAPI whose absence I’ve been asked about a number of times since the API changed. The first was the <strong>terms</strong> endpoint, which returned a JSON list of all the fields that could be queried, their types and possible values. The second was the <code>breakdown</code> parameter which could be added to API queries to include a frequency table of terms in the results, and was very handy for statistical analysis.</p>
<p>Until very recently I thought there was no way to reproduce either functionality in the new API without constructing lists manually and/or running a lot of queries using the main search endpoint. And, as far as I know, there aren’t any <em>exact</em> equivalents. But it turns out you can get (most of) the same information, plus more that wasn’t queryable before.</p>
<p>However, it’s undocumented and not easy to use without some background knowledge about the underlying data and how search functions work. So I’m writing this to fill in the gaps (and provide a resource that I can point enquirers to in the future).</p>
<p>Note that I’m still learning about the functions and this post may be subject to minor revisions.</p>
</section>
<section id="discovery" class="level2">
<h2 class="anchored" data-anchor-id="discovery">Discovery</h2>
<p>The solution to both problems lies in the <a href="https://www.oldbaileyonline.org/search/statistical">statistics search</a>. When you run a search there, you can see a “Download this data” link at the bottom of the table or visualisation it displays; if you click on the link it’ll download a CSV file. That’s pretty useful.</p>
<p>But it gets better when you inspect the URL in the download link. (If you’re not familiar with doing that, <a href="https://programminghistorian.org/en/lessons/downloading-multiple-records-using-query-strings#understanding-url-queries">the Programming Historian has a quick primer</a>.)</p>
<p>This is the download URL for a default offence categories search:</p>
<ul>
<li>https://www.dhi.ac.uk/api/data/csv/agg/oldbailey_offence?series=offence_category</li>
</ul>
<p>It looks very much like an API URL (“https://www.dhi.ac.uk/api/data/…”), and I could infer that it <em>agg</em>regates data into a <em>CSV</em> &nbsp;file related to <em>oldbailey_offence</em>s… but it isn’t mentioned anywhere in the API documentation.</p>
<p>We all like a good mystery, don’t we? Let’s have a quick look at what it fetches.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here) </span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(janitor)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glue)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(httr)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(jsonlite)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(listviewer)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>obo_offence_category_stats_csv <span class="ot">&lt;-</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_csv</span>(<span class="st">"https://www.dhi.ac.uk/api/data/csv/agg/oldbailey_offence?series=offence_category"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This looks nice. There’s a <code>key</code> column with what I know are our offence categories’ names <em>and</em> a <code>doc_count</code> column, presumably counts of results. Counting what though? The default for statistical offence searches is to count by offence, so that’s the most likely (and is confirmed on the site results page).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>obo_offence_category_stats_csv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 2
  key           doc_count
  &lt;chr&gt;             &lt;dbl&gt;
1 breakingPeace      7696
2 damage             1054
3 deception         15879
4 kill               5378
5 miscellaneous      3233
6 royalOffences     10681
7 sexual             7224
8 theft            151011
9 violentTheft       9016</code></pre>
</div>
</div>
<p>Let’s test it out by running <code>breakingPeace</code> through an API search query.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>breaking_peace_json <span class="ot">&lt;-</span> <span class="fu">fromJSON</span>(<span class="st">"https://www.dhi.ac.uk/api/data/oldbailey_record?offence=breakingPeace&amp;div_type=trialAccount"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>That gets, as anticipated, the first ten results for offences in the top level category of Breaking Peace. The total trial <code>hits</code> (7465) are lower than the <code>doc_count</code> (7696).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">jsonedit</span>(breaking_peace_json<span class="sc">$</span>hits)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="jsonedit html-widget html-fill-item" id="htmlwidget-c794bda9535130cb142d" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-c794bda9535130cb142d">{"x":{"data":{"total":7465,"max_score":[],"hits":{"_index":["dhids_oldbailey_record","dhids_oldbailey_record","dhids_oldbailey_record","dhids_oldbailey_record","dhids_oldbailey_record","dhids_oldbailey_record","dhids_oldbailey_record","dhids_oldbailey_record","dhids_oldbailey_record","dhids_oldbailey_record"],"_type":["doc","doc","doc","doc","doc","doc","doc","doc","doc","doc"],"_id":["AYxELexqPld_y58Rzt3Q","AYxEMzauPld_y58R0OBx","AYxEMzauPld_y58R0OB3","AYxEMHOEPld_y58Rz88D","AYxENCqfPld_y58R0Txd","AYxENL5KPld_y58R0XKL","AYxELxG7Pld_y58Rz0cW","AYxEMBqEPld_y58Rz6vy","AYxENOGKPld_y58R0X9Z","AYxELyeOPld_y58Rz0-O"],"_score":[null,null,null,null,null,null,null,null,null,null],"_source":{"idkey":["t16750115-3","t16751208-2","t16751208-8","t16770425-6","t16781211e-28","t16790430-14","t16790605-16","t16821206-7","t16830223-21","t16831212-28"],"images":["https://www.dhi.ac.uk/san/ob/1670s/16750115006.gif",["https://www.dhi.ac.uk/san/ob/1670s/16751208003.gif","https://www.dhi.ac.uk/san/ob/1670s/16751208004.gif"],"https://www.dhi.ac.uk/san/ob/1670s/16751208007.gif",["https://www.dhi.ac.uk/san/ob/1670s/16770425005.gif","https://www.dhi.ac.uk/san/ob/1670s/16770425006.gif","https://www.dhi.ac.uk/san/ob/1670s/16770425007.gif"],[],"https://www.dhi.ac.uk/san/ob/1670s/16790430006.gif",["https://www.dhi.ac.uk/san/ob/1670s/16790605007.gif","https://www.dhi.ac.uk/san/ob/1670s/16790605008.gif"],"https://www.dhi.ac.uk/san/ob/1680s/16821206002.gif","https://www.dhi.ac.uk/san/ob/1680s/16830223004.gif","https://www.dhi.ac.uk/san/ob/1680s/16831212004.gif"],"text":["The next was one Edward Coker who stood indicted for the ravishing of a Child of 11 yeares old, the Child was there and gave her Evidence in Court that the said Coker coming into her Aunts house where she lived, did get her into a Room and did there force her: The Ant attested that she hearing the Child cry out, came into the Room where he was in the dark with her, and found by evident tokens that the Child had bin abused, but although the fact appeared very foul against him yet the Circumstance","After these a Boy of about fourteen or fifteen years of age took his Tryal, it seems he was removed by Habeas Corpus from Northampton-Goal, where the fact was committed as followeth. The aforesaid Boy being the Son of an Yeoman in the said County of Northampton , was employed by his father to receive a summ of money, which accordingly he did; but upon I know not what occasion mispent, or lost the greatest part of the money, and being conscious to himself how ill a thing he had done, and how dear","One for fellony and burglary , firing a Pistol, and drawing his Weapon at the constable .","The next was a Case wholly extraordinary; and as it was the first President of Punishment on that most necessary Statute against cutting off Noses, disfiguring and maiming his Majesties Subjects; so in the Circumstances, for Malice, Cruelty, and Barbarity, it exceeds all the Presidents of former Ages. A young man of Enfield , being Fellow- servant with a very pretty young maid , pretended Love to her; but meeting with a Repulse, he consults his Sister, who advised him to get to bed to her, and g","A Lieutenant and some Soldier s were Indicted for misdemeanor committed by them, in endeavouring in a riotous manner to take away a Prisoner, the 16th. of November last, out of the Custody of one Newton, a Serjeant in London . They all confess'd themselves guilty of the offence , and submitted to the Mercy of the Court. Whereupon Mr. Lane, Comptroller of the Chamber of London, being of Counsel for the King, opened the Cause, to give the Court satisfaction in the matter: That one Sparks being Arr","A Gentleman and two others concerned with him in attempting, above a year ago, to steal and force away a young Lady of eminent Quality, on the Highway, for which some of their Accomplices formerly taken, were condemned to die, but obtained a Pardon, came now to take a Tryal for the same , being charged with two Indictments, one for Felony, on which they were acquitted ; another for a Riot , to which they pleaded guilty , and were fined, the Gentleman 1000 l. and the other two 500 l. apiece .","A Gentleman having (but ungenteely at the Devil-Tavern ) ran another into the belly, and quite through the body; a very dangerous wound, upon scarce any provocation, and before the other so much as saw his sword, the same being drawn under the Table, he was now indicted for the Assault , and though he endeavour'd in vain to have ballanc'd it with bringing a Cross-Indictment; yet being found guilty , he was fined 100 l. committed in Execution till the same paid, and to find Sureties for the good ","Ten Apprentice s were Indicted for a Ryot committed in the City of London , viz. Thomas Page , George Dicks , John Brown , Francis Peirce , Gamaliel Webb , Thomas Fisher , Thomas Langham , Joseph Tenant , Thomas Turner , George Hickman , whereof the three last were acquitted , Thomas Langham was Indicted for an Assault also upon the Body of William Spencer , as the said William Spencer was peaceably passing the Street, near St. Mary Woolchurch , but Evidence being given in Court that the said Lu","Joseph Lawson , was brought to the Bar upon the account of the Riot of Apprentices in Cheap side , but none appearing against him. he was discharged .","Nathaniel Hartshorn , and Samuel Starkey , (formerly 'Servant s to Goodenough and Aaron Smith ) Indicted for coming to the House of William Lord Pagett , at West-Drayden , demanding Entrance at Three or Four a Clock in the Morning, with Pistols and drawn Swords in their hands, under pretence of Searching for Traytors, offering great Rudeness and Violence, forcing all the Servants (one excepted) into the Hall, set a Guard over them, then making the Steward shew them all the House ; likewise confi"],"title":["Edward Coker. Sexual Offences; rape, Breaking Peace; assault. 15th January 1675.","Breaking Peace; wounding. 8th December 1675.","Theft; burglary, Breaking Peace; assault. 8th December 1675.","Breaking Peace; wounding. 25th April 1677.","Breaking Peace; riot. 11th December 1678.","Miscellaneous; kidnapping, Breaking Peace; riot. 30th April 1679.","Breaking Peace; wounding. 5th June 1679.","Thomas Page. George Dicks. John Brown. Francis Peirce. Gamaliel Webb. Thomas Fisher. Thomas Langham. Joseph Tenant. Thomas Turner. George Hickman. Breaking Peace; riot, Breaking Peace; assault. 6th December 1682.","Joseph Lawson. Breaking Peace; riot. 23rd February 1683.","Nathaniel Hartshorn. Samuel Starkey. Breaking Peace; assault. 12th December 1683."]},"sort":[[-9308044800000,3],[-9279792000000,2],[-9279792000000,8],[-9236246400000,6],[-9184838400000,28],[-9172742400000,14],[-9169632000000,16],[-9059040000000,7],[-9052214400000,21],[-9026985600000,28]]}},"options":{"mode":"tree","modes":["text","tree","table"]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="digging-deeper" class="level2">
<h2 class="anchored" data-anchor-id="digging-deeper">Digging deeper</h2>
<p>I’m calling these <code>agg</code> queries to differentiate them from the API search and single record queries I’ve already written about.</p>
<p>After various tests and snafus, I worked out the key components of the URLs:</p>
<ul>
<li>the fixed part of the URL is <strong>https://www.dhi.ac.uk/api/data/csv/agg/</strong></li>
<li>the unit to count by is in the next path segment before the query string, eg <strong>/oldbailey_offence</strong>; it’s always prefixed by “oldbailey_”</li>
<li>the important bits of the query string are <code>series</code> and <code>rows</code></li>
</ul>
<p>NB: you may also see a <code>countby</code> in query strings when exploring searches. I don’t advise using it in API queries; I tested it out quite a bit and I think it either doesn’t do anything at all or the <code>oldbailey_*</code> path parameter always takes precedence.</p>
<section id="what-to-count-by" class="level3">
<h3 class="anchored" data-anchor-id="what-to-count-by">what to count by?</h3>
<p>I should emphasise that what you count by in OBO statistical searches can matter <em>a lot</em>.</p>
<p>There are in fact six options: offence, verdict, punishment, defendant, victim and trial. Why so many?!</p>
<p>The OBO data is <em>not</em> simple tabular data. In any given trial, there can be multiple defendants, offences, verdicts, punishments and victims. So you can get (as seen with the <code>breakingPeace</code> query) very different results when you change what you count by, and the most appropriate choice is likely to depend on what kind of search or analysis you’re doing.</p>
<p>We spent quite a while, way back in about 2008, discussing the most appropriate countby defaults for each search; if you run a few queries on the site changing the search category but keeping the default counts, you can see how it changes. The complexity of the statistics tool led us to write <a href="https://www.oldbaileyonline.org/about/doingstatistics">a guide to its use</a>.</p>
<p>It doesn’t become any less complex just because you interact it with it via the API rather than the search form on the site. In some respects it needs even more care, because searches on the site return much more information about the search (in the display it tells you exactly what was counted and what it was counted by). The <code>agg</code> query downloads lose much of that context. Plus, when constructing an <code>agg</code> query, you have to specify what you want to count by; you can’t just let the site do it for you.</p>
<p>Let’s look again at the offence categories query, and this time change to /oldbailey_trial. Now the total for <code>breakingPeace</code> matches the json hits total.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>obo_offence_trial_query <span class="ot">&lt;-</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_csv</span>(<span class="st">"https://www.dhi.ac.uk/api/data/csv/agg/oldbailey_trial?series=offence_category"</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>obo_offence_trial_query</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 2
  key           doc_count
  &lt;chr&gt;             &lt;dbl&gt;
1 breakingPeace      7465
2 damage             1027
3 deception         14116
4 kill               5301
5 miscellaneous      3163
6 royalOffences     10477
7 sexual             6943
8 theft            142539
9 violentTheft       8628</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>breaking_peace_json<span class="sc">$</span>hits<span class="sc">$</span>total</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 7465</code></pre>
</div>
</div>
<p>In summary:</p>
<p>The one time it shouldn’t matter too much what you count by is if you simply want a list of the available terms for a search query.</p>
<p>If you want counts that will match the hits totals returned by the search API, use <code>/oldbailey_trial</code>. (You’ll also need to add <code>div_type=trialAccount</code> to the search query to ensure they match <em>exactly</em>.)</p>
<p>If you want counts for a statistical analysis and you want your results to be reproducible, choose the most appropriate count carefully <em>and document your choice every time</em>.</p>
</section>
<section id="query-strings" class="level3">
<h3 class="anchored" data-anchor-id="query-strings">query strings</h3>
<p>If you’re looking at the statistics search form it has four main sections (apart from filtering options in the sidebar, which I’m not going into here but would expect to work in much the same way as other API queries):</p>
<ol type="1">
<li>select a search category (required)</li>
<li>select a second category (optional) - adding this generates more complex tables (<a href="https://en.wikipedia.org/wiki/Contingency_table">crosstabs</a>)</li>
<li>count by (optional)</li>
<li>display output (optional)</li>
</ol>
<p>1 and 2 use identical lists of variables, which I’ve pulled out of the search form for convenience.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>obo_agg_variables_csv <span class="ot">&lt;-</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_csv</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data/obo_agg_variables.csv"</span>))</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>obo_agg_variables_csv<span class="sc">$</span>name</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "offence_category"       "offence_subcategory"    "plea"                  
 [4] "verdict_category"       "verdict_subcategory"    "punishment_category"   
 [7] "punishment_subcategory" "defendant_gender"       "defendant_age"         
[10] "victim_gender"          "victim_age"             "victim_hisco_class_1"  
[13] "victim_hisco_label"     "victim_institution"     "decade"                
[16] "year"                  </code></pre>
</div>
</div>
<p>Translating from the search form to <code>agg</code> query strings, the first search box is equivalent to <code>series</code> and the second, if you want it, is <code>rows</code>. As far as I can tell from testing you’ll never need anything else. You can have <em>any</em> combination of variables you like in crosstabs (though some are likely to make more sense than others).</p>
</section>
<section id="a-crosstabs-example" class="level3">
<h3 class="anchored" data-anchor-id="a-crosstabs-example">a crosstabs example</h3>
<p>Let’s say I’d like a breakdown of offence subcategories per year, counting by offence.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>agg_query_url <span class="ot">&lt;-</span> <span class="st">"https://www.dhi.ac.uk/api/data/csv/agg/oldbailey_offence?rows=offence_subcategory&amp;series=year"</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>offence_subcategory_year_csv <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(agg_query_url)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The result:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>offence_subcategory_year_csv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 240 × 74
     key doc_count animalTheft bigamy burglary coiningOffences grandLarceny
   &lt;dbl&gt;     &lt;dbl&gt;       &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;           &lt;dbl&gt;        &lt;dbl&gt;
 1  1674        41           5      1       12               1            1
 2  1675        59           4      0        8               1            7
 3  1676        87           4      5       11               1            9
 4  1677        91           6      2        8               5            7
 5  1678       132          16      4        2               8           26
 6  1679       131          10      0        6              10            8
 7  1680       127           5      1       16               9           21
 8  1681       135           8      3       11               2           22
 9  1682       174           5      4        7               5           34
10  1683       215          17      3        5              10           34
# ℹ 230 more rows
# ℹ 67 more variables: highwayRobbery &lt;dbl&gt;, housebreaking &lt;dbl&gt;,
#   infanticide &lt;dbl&gt;, killOther &lt;dbl&gt;, murder &lt;dbl&gt;, rape &lt;dbl&gt;,
#   receiving &lt;dbl&gt;, religiousOffences &lt;dbl&gt;, theftFromPlace &lt;dbl&gt;,
#   theftOther &lt;dbl&gt;, arson &lt;dbl&gt;, assault &lt;dbl&gt;, forgery &lt;dbl&gt;,
#   miscellaneousOther &lt;dbl&gt;, pervertingJustice &lt;dbl&gt;, pettyLarceny &lt;dbl&gt;,
#   pettyTreason &lt;dbl&gt;, pocketpicking &lt;dbl&gt;, robbery &lt;dbl&gt;, …</code></pre>
</div>
</div>
</section>
</section>
<section id="scaling-up" class="level2">
<h2 class="anchored" data-anchor-id="scaling-up">Scaling up</h2>
<p>Chances are you’ll want to get more than one thing at a time! Here are a couple of examples.</p>
<section id="download-multiple-csvs" class="level3">
<h3 class="anchored" data-anchor-id="download-multiple-csvs">download multiple CSVs</h3>
<p>Maybe you want to get the CSVs for all the search variables, ready to use in search scripts. Here’s one way to do it, for the simple <code>series</code> search for each variable.</p>
<p>First build the query URLs and filenames.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># construct a) URLs and b) filenames from the agg variables list</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co"># I like to embed info about the data in the filename: </span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co"># name of variable + count by + date of download</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>date_stamp <span class="ot">&lt;-</span> <span class="fu">today</span>() <span class="sc">|&gt;</span> <span class="fu">format</span>(<span class="st">'%Y%m%d'</span>)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>obo_agg_variables <span class="ot">&lt;-</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>obo_agg_variables_csv <span class="sc">|&gt;</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">url =</span> <span class="fu">glue</span>(<span class="st">"https://www.dhi.ac.uk/api/data/csv/agg/oldbailey_trial?series={name}"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">filename =</span> <span class="fu">glue</span>(<span class="st">"{name}-bytrial-{date_stamp}"</span>))</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="co"># pull out the variable names</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>obo_agg_variables_names <span class="ot">&lt;-</span> obo_agg_variables<span class="sc">$</span>name</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="co"># pull out the filenames</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>obo_agg_variables_filenames <span class="ot">&lt;-</span> obo_agg_variables<span class="sc">$</span>filename</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then the process for fetching and saving is much the same as I used in my previous <a href="../notes/example-api.html">API search example</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># function to write the CSVs to files</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co"># the outputs/csv/single/ folder must already exist</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>output_obo_single_csv <span class="ot">&lt;-</span> <span class="cf">function</span>(data, names) {</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    folder_path <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"outputs/csv/single"</span>)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(data, <span class="fu">paste0</span>(folder_path, <span class="st">"/"</span>, names, <span class="st">".csv"</span>) )</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="co"># slightly slow down read_csv with slowly() when it's used in map.</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>slow_csv <span class="ot">&lt;-</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slowly</span>(read_csv, <span class="at">rate=</span><span class="fu">rate_delay</span>(<span class="dv">1</span>))</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="co"># use purrr::map to fetch the data for each variable</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>obo_agg_variables_csvs <span class="ot">&lt;-</span> <span class="fu">map</span>(obo_agg_variables<span class="sc">$</span>url, slow_csv)</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="co"># add the variable names back to the list elements</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(obo_agg_variables_csvs) <span class="ot">&lt;-</span> obo_agg_variables_names</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a><span class="co"># write the CSVs with purrr::pmap.</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="fu">invisible</span>(</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">data=</span>obo_agg_variables_csvs,</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">names=</span>obo_agg_variables_filenames</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pmap</span>(output_obo_single_csv)</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Checking out one of the files:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>obo_agg_punishment_category_csv <span class="ot">&lt;-</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_csv</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"outputs/csv/single/punishment_category-bytrial-20250529.csv"</span>))</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>obo_agg_punishment_category_csv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 2
  key        doc_count
  &lt;chr&gt;          &lt;dbl&gt;
1 corporal        8910
2 death          10486
3 imprison       80937
4 miscPunish     12492
5 noPunish        4838
6 transport      40521</code></pre>
</div>
</div>
</section>
<section id="all-the-combinations-for-crosstabs" class="level3">
<h3 class="anchored" data-anchor-id="all-the-combinations-for-crosstabs">all the combinations for crosstabs</h3>
<p>There is a neat R function, combn(), to make a set of all unique pairs from a list, when you want to avoid reverse-duplicates (ie, you don’t need both “a”+“b” <em>and</em> “b”+“a”). The only downside is that it returns a matrix, so you need to convert back to a tibble/dataframe.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>obo_agg_variables_pairs <span class="ot">&lt;-</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">combn</span>(obo_agg_variables_names, <span class="at">m=</span><span class="dv">2</span> ) <span class="sc">|&gt;</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># it's a *very* wide matrix; t() transposes rows and columns</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">t</span>() <span class="sc">|&gt;</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># convert matrix to tibble; .name_repair to create column names</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>(<span class="at">.name_repair =</span> <span class="sc">~</span><span class="fu">c</span>(<span class="st">"series"</span>, <span class="st">"rows"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>obo_agg_variables_pairs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 120 × 2
   series           rows                  
   &lt;chr&gt;            &lt;chr&gt;                 
 1 offence_category offence_subcategory   
 2 offence_category plea                  
 3 offence_category verdict_category      
 4 offence_category verdict_subcategory   
 5 offence_category punishment_category   
 6 offence_category punishment_subcategory
 7 offence_category defendant_gender      
 8 offence_category defendant_age         
 9 offence_category victim_gender         
10 offence_category victim_age            
# ℹ 110 more rows</code></pre>
</div>
</div>
<p>On the other hand, if you want <em>all</em> the possible combinations including reverse-duplicates, you could instead use <a href="https://tidyr.tidyverse.org/reference/expand_grid.html">tidyr::expand_grid()</a> which will “create a tibble from all combinations of inputs”. That’ll include identical pairs, so you need to filter those out.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>obo_agg_variables_pairs_all <span class="ot">&lt;-</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand_grid</span>(<span class="at">rows=</span>obo_agg_variables_names, </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">series=</span>obo_agg_variables_names) <span class="sc">|&gt;</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(rows <span class="sc">!=</span> series)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>obo_agg_variables_pairs_all</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 240 × 2
   rows             series                
   &lt;chr&gt;            &lt;chr&gt;                 
 1 offence_category offence_subcategory   
 2 offence_category plea                  
 3 offence_category verdict_category      
 4 offence_category verdict_subcategory   
 5 offence_category punishment_category   
 6 offence_category punishment_subcategory
 7 offence_category defendant_gender      
 8 offence_category defendant_age         
 9 offence_category victim_gender         
10 offence_category victim_age            
# ℹ 230 more rows</code></pre>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>Site created by <a href="https://sharonhoward.org">Sharon Howard</a> with <a href="https://quarto.org/">Quarto</a></p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>